<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ProtacMLA - Protein Mutation & Ligand Analysis</title>
<script src="https://3Dmol.org/build/3Dmol-min.js"></script>
<style>
  body { margin:0; font-family: ui-sans-serif, system-ui; background: #f0f4ff; }
  .header {
    padding:15px; background:rgba(87,134,236,.9); color:#fff; text-align:center;
    font-size:22px; font-weight:700; display:flex; align-items:center;
    justify-content:center; gap:12px; position:sticky; top:0; z-index:1000;
  }
  .header img { height:40px; width:auto; }

  /* Viewer section */
  .viewer-section {
    display:flex; gap:10px; padding:10px; height:320px; min-height:220px;
    max-height:620px; background:#ecebeb; border-radius:10px; margin:10px;
    box-shadow:0 4px 15px rgba(0,0,0,.15); resize:vertical; overflow:hidden;
  }
  .viewer {
    flex:2; min-width:65%; height:100%; border-radius:6px; background:#fff;
    position:relative; overflow:hidden;
  }
  .viewer canvas {
    width:100% !important; height:100% !important; display:block;
  }
  .info-panel {
    flex:1; min-width:30%; height:100%; background:#fff; border-radius:8px;
    padding:8px; font-size:14px; overflow-y:auto;
    box-shadow:inset 0 0 5px rgba(0,0,0,.08);
  }
  .info-panel h3 {
    text-align:center; margin:4px 0 6px; color:#0657B6; font-size:16px;
  }
  .info-panel ul { list-style:none; padding:0; margin:0; }
  .info-panel li { padding:4px; border-bottom:1px solid #e7e7e7; font-size:13px; }

  /* Collapsible Viewer Options */
  .collapsible {
    background:#0ea5e9; color:#fff; cursor:pointer; padding:10px;
    width:95%; margin:6px auto 8px; text-align:left; border:none;
    outline:none; font-size:15px; border-radius:8px;
  }
  .collapsible:hover, .collapsible.active { background:#0284c7; }
  .options {
    display:none; background:#fff; width:95%; margin:0 auto 10px; border-radius:10px;
    box-shadow:0 4px 14px rgba(0,0,0,.12); padding:10px;
  }
  .opt-grid {
    display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px;
  }
  .opt-card { border:1px solid #e8e8e8; border-radius:10px; padding:10px; }
  .opt-card label { display:block; font-size:13px; margin-bottom:6px; color:#333; }
  .opt-card select, .opt-card input[type="range"] {
    width:100%; padding:6px; border:1px solid #d6d6d6; border-radius:8px;
    font-size:14px; background:#fafafa;
  }
  .row-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:6px; }
  .btn { padding:7px 10px; border:1px solid #cfd8ff; background:#f6f8ff; border-radius:8px; cursor:pointer; }
  .btn.primary { background:#0ea5e9; color:#fff; border-color:#0ea5e9; }
  .btn.primary:hover { background:#0284c7; }

  /* Controls */
  .controls { text-align:center; margin:12px; }
  .controls input, .controls button {
    padding:6px 10px; font-size:14px; margin:4px; border-radius:6px;
    border:1px solid #ccc;
  }
  .controls button {
    background:#0ea5e9; color:#fff; cursor:pointer; font-weight:700;
  }
  .controls button:hover { background:#0284c7; }

  /* Main Panels */
  .main {
    display:flex;
    flex-direction: row;
    gap: 10px;
    padding: 10px;
    min-height: 400px;
    height: auto;
    align-items: stretch;
  }
  .panel {
    flex: 1;
    min-width: 200px;
    min-height: 300px;
    max-height: 600px;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    resize: vertical;
    overflow: auto;
    display: flex;
    flex-direction: column;
  }
  .panel iframe {
    flex: 1;
    width: 100%;
    border: none;
    border-radius: 12px;
  }

  /* AI Databases & Tools */
  .ai-analysis {
    margin:15px; padding:20px; background:#fff; border-radius:16px;
    box-shadow:0 4px 20px rgba(0,0,0,.12);
  }
  .ai-analysis h3 {
    text-align:center; color:#0657B6; margin-bottom:14px;
  }
  .tool-section { margin-bottom:18px; }
  .tool-section h4 {
    font-size:18px; color:#333; margin-bottom:8px; border-bottom:2px solid #0ea5e9; padding-bottom:5px;
  }
  .tool-list {
    display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px;
  }
  .tool-card {
    background:#f9f9ff; padding:12px; border-radius:10px; border:1px solid #e9e9ff;
    text-align:center; transition:.2s;
  }
  .tool-card:hover {
    background:#eaf4ff; transform:translateY(-2px);
    box-shadow:0 4px 10px rgba(0,85,170,.18);
  }
  .tool-card a {
    text-decoration:none; color:#0657B6; font-weight:700; font-size:15px;
  }
  .tool-card p { margin-top:6px; font-size:13px; color:#333; }
  .tutorial-btn {
    position: absolute;
    right: 20px;
    top: 15px;
    background: #fff;
    color: #0ea5e9;
    font-weight: bold;
    text-decoration: none;
    padding: 6px 12px;
    border-radius: 8px;
    border: 1px solid #e90ecc;
    transition: background 0.3s, color 0.3s;
  }
  .tutorial-btn:hover {
    background: #0ea5e9;
    color: #fff;
  }
</style>
</head>
<body>
<div class="header">
  <img src="protac_head.png" alt="Protac Logo">
  ProtacMLA - PROTAC Mutation & Ligand Analysis
  <a href="tutorial.pdf" target="_blank" class="tutorial-btn">TUTORIAL</a>
</div>

  <!-- Viewer -->
  <div class="viewer-section">
    <div class="viewer" id="viewer3d"></div>
    <div class="info-panel">
      <h3>Structure Details</h3>
      <ul id="chainInfo"><li>Load a PDB to view details...</li></ul>
      <h3>Ligands</h3>
      <ul id="ligandInfo"><li>No ligands detected yet...</li></ul>
      <label style="margin-top:10px; display:block;">
        <input type="checkbox" id="toggleLigands" checked onchange="toggleLigands()"> Show Ligands
      </label>
    </div>
  </div>

  <!-- Collapsible Viewer Options -->
  <button class="collapsible" id="toggleOptions">Viewer Options</button>
  <div class="options" id="optionsPanel">
    <div class="opt-grid">
      <div class="opt-card">
        <label>Protein Representation</label>
        <select id="proteinStyle">
          <option value="cartoon" selected>Cartoon</option>
          <option value="stick">Stick</option>
          <option value="sphere">Sphere</option>
        </select>
      </div>
      <div class="opt-card">
        <label>Background</label>
        <select id="bgColor">
          <option value="white" selected>White</option>
          <option value="black">Black</option>
          <option value="#f0f4ff">Soft Blue</option>
        </select>
        <div class="row-actions" style="margin-top:8px">
          <button class="btn primary" id="btnReset">Reset</button>
          <button class="btn" id="btnScreenshot">Screenshot</button>
          <button class="btn" id="btnCenter">Center</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <input type="text" id="pdbInput" placeholder="Enter PDB ID (e.g., 6lu7)">
    <button onclick="loadPDB()">Load PDB from RCSB</button>
    <label for="pdbFile"><b>or Upload Local File:</b></label>
    <input type="file" id="pdbFile" accept=".pdb" onchange="loadLocalPDB(event)">
  </div>

<!-- Tool Panels -->
<div class="main">
  <div class="panel">
    <iframe id="mutationFrame" src="mutation_code.html"></iframe>
  </div>
  <div class="panel">
    <iframe id="ligandFrame" src="ligand_code.html"></iframe>
  </div>
  <div class="panel">
    <!-- PBEE Google Colab tool -->
    <iframe src="https://colab.research.google.com/drive/1lu1dC0yRltKK_Wp-gF26oHcZSCiHaI8b#scrollTo=2cupP75FoyvZ"></iframe>
  </div>
</div>

  <!-- Databases & AI tools -->
  <div class="ai-analysis">
    <h3>Databases & Tools for PROTAC and Protein Research</h3>
    <!-- Your existing database & tool cards remain unchanged -->
  </div>

<script>
  let viewer = $3Dmol.createViewer("viewer3d", { backgroundColor: "white" });
  let pdbCache = '';
  let showLigands = true;
  const excludedLigands = new Set(['HOH','WAT','NA','CL','MG','CA','K','SO4','PO4','MN','ZN','CU','FE']);
  const chainColors = ['red','green','blue','orange','purple','cyan','magenta','yellow'];

  new ResizeObserver(() => viewer.resize()).observe(document.getElementById('viewer3d'));
  window.addEventListener('resize', () => viewer.resize());

  document.getElementById('toggleOptions').onclick = () => {
    const p = document.getElementById('optionsPanel');
    const open = p.style.display === 'block';
    p.style.display = open ? 'none' : 'block';
    document.getElementById('toggleOptions').classList.toggle('active', !open);
  };

  async function loadPDB() {
    const pdbId = document.getElementById('pdbInput').value.trim();
    if (!pdbId) { alert("Enter a valid PDB ID"); return; }
    try {
      const response = await fetch(`https://files.rcsb.org/download/${pdbId}.pdb`);
      if (!response.ok) throw new Error("PDB not found");
      renderStructure(await response.text());
    } catch (err) { alert("Error loading PDB: " + err.message); }
  }

  function loadLocalPDB(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => renderStructure(e.target.result);
    reader.readAsText(file);
  }

  function renderStructure(pdbData) {
    pdbCache = pdbData;
    viewer.clear();
    viewer.addModel(pdbData, "pdb");

    const chains = {};
    pdbData.split("\n").forEach(line => {
      if (line.startsWith("ATOM")) {
        const chain = line.substr(21, 1).trim();
        const resName = line.substr(17, 3).trim();
        const resSeq = line.substr(22, 4).trim();
        if (!chains[chain]) chains[chain] = new Set();
        chains[chain].add(`${resName} ${resSeq}`);
      }
    });
    Object.keys(chains).forEach((chain, idx) => {
      viewer.setStyle({ chain: chain, hetflag: false }, { cartoon: { color: chainColors[idx % chainColors.length] } });
    });

    applyLigandStyles();
    viewer.zoomTo();
    viewer.render();
    updateChainInfo(chains);
    updateLigandInfo(pdbData);
  }

  function applyLigandStyles() {
    if (!pdbCache || !showLigands) return;
    const ligands = [];
    pdbCache.split("\n").forEach(line => {
      if (line.startsWith("HETATM")) {
        const lig = line.substr(17, 3).trim();
        if (!excludedLigands.has(lig)) ligands.push(lig);
      }
    });
    if (ligands.length > 0) {
      viewer.setStyle({ hetflag: true, resn: ligands }, { stick: { colorscheme: "greenCarbon", radius: 0.3 } });
    }
  }

  function toggleLigands() {
    showLigands = document.getElementById('toggleLigands').checked;
    renderStructure(pdbCache);
  }

  function updateChainInfo(chains) {
    const panel = document.getElementById("chainInfo");
    panel.innerHTML = Object.keys(chains).length
      ? Object.keys(chains).map((c, idx) => `<li><b>Chain ${c}:</b> <span style="color:${chainColors[idx % chainColors.length]}">${[...chains[c]].join(", ")}</span></li>`).join("")
      : "<li>No chain data found.</li>";
  }

  function updateLigandInfo(pdbText) {
    const ligands = new Set();
    pdbText.split("\n").forEach(line => {
      if (line.startsWith("HETATM")) {
        const lig = line.substr(17, 3).trim();
        if (!excludedLigands.has(lig)) ligands.add(lig);
      }
    });
    const panel = document.getElementById("ligandInfo");
    panel.innerHTML = ligands.size
      ? [...ligands].map(lig => `<li>${lig}</li>`).join("")
      : "<li>No relevant ligands found.</li>";
  }

  document.getElementById('proteinStyle').onchange = e => {
    if (!pdbCache) return;
    viewer.clear();
    renderStructure(pdbCache);
    const style = e.target.value;
    viewer.setStyle({ hetflag: false }, { [style]: { color: 'spectrum' } });
    applyLigandStyles();
    viewer.zoomTo();
    viewer.render();
  };
  document.getElementById('bgColor').onchange = e => viewer.setBackgroundColor(e.target.value);
  document.getElementById('btnReset').onclick = () => { if (pdbCache) renderStructure(pdbCache); };
  document.getElementById('btnCenter').onclick = () => { viewer.zoomTo(); viewer.render(); };
  document.getElementById('btnScreenshot').onclick = () => {
    try {
      viewer.render();
      const pngData = viewer.pngURI();
      const link = document.createElement('a');
      link.href = pngData;
      link.download = 'pdb_view.png';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (error) {
      alert("Screenshot failed: " + error.message);
    }
  };
</script>
</body>
</html>
